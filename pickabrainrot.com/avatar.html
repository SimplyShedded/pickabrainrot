<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Avatar Loader</title>
</head>
<body style="margin:0;">
  <div id="avatar-container" style="text-align:center; margin-top:10px;"></div>

  <script>
    const AVATAR_SIZE = "150x150";
    const container = document.getElementById("avatar-container");
    let lastReqId = 0;
    let prevController = null;
    const avatarCache = new Map();

    const clean = s => (s || "").trim().replace(/[^A-Za-z0-9_]/g, "").slice(0, 20);
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    async function fetchWithRetry(url, opts = {}, tries = 3, backoff = 600) {
      for (let i = 0; i < tries; i++) {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), opts.timeout || 6000);
        try {
          const res = await fetch(url, { ...opts, signal: controller.signal, cache: "no-store" });
          clearTimeout(t);
          if (res.status === 429) {
            const ra = parseInt(res.headers.get("retry-after") || "1", 10);
            await sleep(Math.max(ra * 1000, backoff * (i + 1)));
            continue;
          }
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res;
        } catch (e) {
          clearTimeout(t);
          if (i === tries - 1) throw e;
          await sleep(backoff * (i + 1));
        }
      }
    }

    async function fromWorker(username) {
      const u = encodeURIComponent(username);
      // FIX: add "?" and pass size to avoid backend defaults
      const url = `https://newdupealt.mydupealt.workers.dev/?username=${u}&size=${AVATAR_SIZE}&t=${Date.now()}`;
      const res = await fetchWithRetry(url, { timeout: 6000 }, 2, 600);
      const data = await res.json();
      if (data && data.image) return data.image;
      throw new Error(data?.error || "Worker gave no image");
    }

    async function fromRoblox(username) {
      const res1 = await fetchWithRetry("https://users.roblox.com/v1/usernames/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usernames: [username], excludeBannedUsers: false }),
        timeout: 6000
      }, 2, 600);

      const j1 = await res1.json();
      const id = j1?.data?.[0]?.id;
      if (!id) throw new Error("Username not found");

      // FIX: small retry loop because imageUrl can be null on first hit
      const base = "https://thumbnails.roblox.com/v1/users/avatar-headshot";
      for (let i = 0; i < 3; i++) {
        const url2 = `${base}?userIds=${id}&size=${AVATAR_SIZE}&format=Png&isCircular=false&t=${Date.now()}`;
        const res2 = await fetchWithRetry(url2, { timeout: 6000 }, 2, 600);
        const j2 = await res2.json();
        const img = j2?.data?.[0]?.imageUrl;
        if (img) return img;
        await sleep(300 + i * 250);
      }
      throw new Error("No thumbnail");
    }

    function setError(msg) {
      container.innerHTML = `<p style="color:#ff5a5a;">${msg}</p>`;
      // safer postMessage (does nothing if unavailable)
      try { parent.postMessage({ iframeHeight: 60 }, "*"); } catch {}
    }

    function showImage(url) {
      container.innerHTML = `
        <img src="${url}" alt="Avatar"
             style="width:150px;height:150px;border-radius:12px;margin-top:10px;display:block;margin-inline:auto;" />
      `;
      const img = container.querySelector("img");
      img.addEventListener("load", () => {
        try { parent.postMessage({ iframeHeight: 170 }, "*"); } catch {}
      });
      img.addEventListener("error", () => setError(""));
    }

    async function getRobloxAvatar(usernameRaw) {
      const username = clean(usernameRaw);
      const myReq = ++lastReqId;

      if (!username || username.length < 3) {
        setError("Enter a valid username.");
        return;
      }

      if (prevController) try { prevController.abort(); } catch {}
      prevController = new AbortController();

      if (avatarCache.has(username)) {
        showImage(avatarCache.get(username));
        return;
      }

      container.innerHTML = `<span style="color:#ddd;"></span>`;
      try { parent.postMessage({ iframeHeight: 80 }, "*"); } catch {}

      try {
        let url;
        try {
          url = await fromWorker(username);
        } catch {
          url = await fromRoblox(username);
        }
        if (myReq !== lastReqId) return;
        avatarCache.set(username, url);
        showImage(url);
      } catch (e) {
        if (myReq !== lastReqId) return;
        setError("");
      }
    }

    let debounceTimer = null;
    window.addEventListener("message", (event) => {
      if (event.data && event.data.username) {
        const name = String(event.data.username || "");
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => getRobloxAvatar(name), 250);
      }
    });
  </script>
</body>
</html>
